dist: trusty

language: c

sudo: required
services:
 - docker

compiler:
 - gcc
 - clang
 
env:
 - CRYPT=sodium
 - CRYPT=tweetnacl
 - CRYPT=mbedtls
 - CRYPT=hacl
 - CRYPT=c25519

before_install:
 - docker pull ubuntu:artful
 - docker run -it -d -v ${TRAVIS_BUILD_DIR}/..:/mnt  --name build ubuntu:artful bash
 - docker exec build ls -al /mnt
 - docker exec build ls -al /mnt/libcose
 - docker exec build apt-get update
 - docker exec build apt-get --yes install build-essential cmake cmake-data pkg-config libcunit1-dev libsodium-dev llvm clang clang-tidy libmbedtls-dev git unzip wget
 - docker exec build git clone https://github.com/intel/tinycbor/ /mnt/tinycbor
 - docker exec -i build bash -c 'cd /mnt/tinycbor && make -j'
 - docker exec build git clone https://github.com/RIOT-OS/tweetnacl /mnt/tweetnacl
 - docker exec build git clone https://github.com/mitls/hacl-c.git /mnt/hacl-c
 - docker exec -i build bash -c 'cd /mnt/hacl-c && make -j'
 - docker exec build wget https://www.dlbeer.co.nz/downloads/c25519-2017-10-05.zip -O /mnt/c25519.zip
 - docker exec build bash -c 'cd /mnt && unzip c25519.zip'

script:
 - docker exec build bash -c "cd /mnt/libcose && make clean clang-tidy CRYPTO=$CRYPT CC=$CC TINYCBOR_ROOT=/mnt/tinycbor"
 - docker exec build bash -c "cd /mnt/libcose && make clean test CRYPTO=$CRYPT CC=$CC TINYCBOR_ROOT=/mnt/tinycbor MBEDTLS_LIB=/usr/lib/x86_64-linux-gnu/libmbedcrypto.so"
